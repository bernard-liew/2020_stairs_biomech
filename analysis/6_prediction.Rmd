---
title: "6_prediction"
output: html_notebook
editor_options: 
  chunk_output_type: console
---
  
# Import library
  
```{r}

rm (list = ls())

# Helper
library (tidyverse)

# Exploration 
library (DataExplorer)
library (janitor)
library (arsenal)
library (ggforce)
library (moments)

# modelling
library (gamlss)
library (gamlss.add)
library (gamlss.dist)
library (bamlss)
library (refund)

# parallel
library(doParallel)
library(foreach)
library (furrr)

# Plotting
library (distreg.vis)
library (cowplot)



```

# Import data

```{r}

output_dir <- "output"

mod_a <- readRDS(file.path(output_dir, "gamlss_allspeed_ankle.RDS"))
mod_k <- readRDS(file.path(output_dir, "gamlss_allspeed_knee.RDS"))
mod_h <- readRDS(file.path(output_dir, "gamlss_allspeed_hip.RDS"))

```

# Diagnostic plots

## MCMC samples

```{r}

m <- list (bmod_a, bmod_k, bmod_h)
plotname <- c("dxmod_ankle.pdf", "dxmod_knee.pdf", "dxmod_hip.pdf")

for (n in seq_along (m)) {
  
  pdf (file = file.path(output_dir, paste0 (plotname[n])))
  plot(m[[n]], which = "samples", ask=FALSE)
  dev.off()
    
  
}


```


# Prediction

## Ankle

### New data

```{r}
m <- mod_a

# Original data used to fit the model
frac <- 0.3
dat <- readRDS("output/df_clean_allspeed.RDS")  %>%
  filter (joint == "ankle") %>% 
  filter(study != "lencioni") %>% # data reported dissimilar to others
  group_by(subj, speed, age, sex, ht, wt, study)%>%
  sample_frac(frac) %>%
  ungroup () %>%
  mutate(sex = as.factor(sex),
         subj = as.factor(subj),
         study = as.factor(study)) %>%
  as.data.frame()

 # New data         
nd <- expand.grid(cycle = 1:101,
                  age = seq(20, 80, 10),
                  speed = c(0.5, 1, 1.5),
                  sex = factor ("m", levels = levels(dat$sex)),
                  ht = 1.7,
                  study = factor ("fukuchi", levels = levels(dat$study)),
                  subj = factor ("fukuchi_1", levels = levels(dat$subj)))

p <- predict (m, 
              newdata = nd, 
              data = dat,
              type = "response")

```

### Curves at different age

```{r}

df.plot <- bind_cols(nd, p) %>%
  mutate (age = factor (age))%>%
  mutate (speed = factor (speed))


f <- ggplot(data = df.plot) +
  geom_line (aes (x = cycle, y = Mean, colour = age)) +
  geom_ribbon(aes(x = cycle, ymin = `2.5%`, ymax = `97.5%`, fill = age), alpha = 0.2) +
  scale_color_manual(values = cbp2) +
  scale_fill_manual(values = cbp2) +
  facet_wrap(~speed, ncol = 3, scales = "fixed") + 
  ylab ("Ankle power (W/kg)") +
  xlab ("%Stride") +
  labs (color = "Age(years)") +
  guides (fill = FALSE) + 
  theme_half_open()

windows()
f


```

```{r}
df.plot <- bind_cols(nd, p) %>%
  mutate (age = factor (age))%>%
  mutate (speed = factor (speed))%>%
  group_by(age, speed) %>%
  mutate (a2 = max (Mean)) %>%
  ungroup () %>%
  filter (Mean == a2)


f <- ggplot(data = df.plot) +
  geom_point (aes (x = age, y = Mean, color = age), size = 2) + 
  geom_errorbar(aes(x = age, ymin = `2.5%`, ymax = `97.5%`, color = age), size = 1) + 
  scale_color_manual(values = cbp2) +
  facet_wrap(~speed, ncol = 3, scales = "fixed") + 
  ylab ("A2 (W/kg)") +
  xlab ("Age") +
  labs (color = "Age(years)") +
  theme_half_open()


f

```

## Knee

### New data

```{r}
m <- bmod_k

# The palette with black:
cbp2 <- c("#000000", "#E69F00", "#56B4E9", "#009E73",
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
          
nd <- expand.grid(cycle = 1:101,
                  age = seq(10, 80, 10),
                  speed = seq(0.8, 1.8, 0.2))

p <- predict (m, 
              newdata = nd, 
              model = "mu", 
              term = c("s(cycle)", "s(age)", "s(speed)"), 
              match.names = FALSE, 
              intercept = TRUE, 
              FUN = c95)

```

### Curves at different age

```{r}

df.plot <- bind_cols(nd, p) %>%
  mutate (age = factor (age))%>%
  mutate (speed = factor (speed))


f <- ggplot(data = df.plot) +
  geom_line (aes (x = cycle, y = Mean, colour = age)) +
  geom_ribbon(aes(x = cycle, ymin = `2.5%`, ymax = `97.5%`, fill = age), alpha = 0.2) +
  scale_color_manual(values = cbp2) +
  scale_fill_manual(values = cbp2) +
  facet_wrap(~speed, ncol = 3, scales = "fixed") + 
  ylab ("Ankle power (W/kg)") +
  xlab ("%Stride") +
  labs (color = "Age(years)") +
  guides (fill = FALSE) + 
  theme_half_open()

f


```

```{r}
df.plot <- bind_cols(nd, p) %>%
  mutate (age = factor (age))%>%
  mutate (speed = factor (speed))%>%
  group_by(age, speed) %>%
  mutate (a2 = max (Mean)) %>%
  ungroup () %>%
  filter (Mean == a2)


f <- ggplot(data = df.plot) +
  geom_point (aes (x = age, y = Mean, color = age), size = 2) + 
  geom_errorbar(aes(x = age, ymin = `2.5%`, ymax = `97.5%`, color = age), size = 1) + 
  scale_color_manual(values = cbp2) +
  facet_wrap(~speed, ncol = 3, scales = "fixed") + 
  ylab ("A2 (W/kg)") +
  xlab ("Age") +
  labs (color = "Age(years)") +
  theme_half_open()


f

```

## Hip

### New data

```{r}
m <- bmod_h

# The palette with black:
cbp2 <- c("#000000", "#E69F00", "#56B4E9", "#009E73",
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
          
nd <- expand.grid(cycle = 1:101,
                  age = seq(10, 80, 10),
                  speed = seq(0.8, 1.8, 0.2))

p <- predict (m, 
              newdata = nd, 
              model = "mu", 
              term = c("s(cycle)", "s(age)", "s(speed)"), 
              match.names = FALSE, 
              intercept = TRUE, 
              FUN = c95)

```

### Curves at different age

```{r}

df.plot <- bind_cols(nd, p) %>%
  mutate (age = factor (age))%>%
  mutate (speed = factor (speed))


f <- ggplot(data = df.plot) +
  geom_line (aes (x = cycle, y = Mean, colour = age)) +
  geom_ribbon(aes(x = cycle, ymin = `2.5%`, ymax = `97.5%`, fill = age), alpha = 0.2) +
  scale_color_manual(values = cbp2) +
  scale_fill_manual(values = cbp2) +
  facet_wrap(~speed, ncol = 3, scales = "fixed") + 
  ylab ("Hip power (Nm/kg)") +
  xlab ("%Stride") +
  labs (color = "Age(years)") +
  guides (fill = FALSE) + 
  theme_half_open()

f


```

```{r}

df.plot <- bind_cols(nd, p) %>%
  filter (cycle < 45) %>%
  mutate (age = factor (age))%>%
  mutate (speed = factor (speed)) %>%
  group_by(age, speed) %>%
  mutate (h1 = max (Mean)) %>%
  ungroup () %>%
  filter (Mean == h1)


f <- ggplot(data = df.plot) +
  geom_point (aes (x = age, y = Mean, color = age), size = 2) + 
  geom_errorbar(aes(x = age, ymin = `2.5%`, ymax = `97.5%`, color = age), size = 1) + 
  scale_color_manual(values = cbp2) +
  facet_wrap(~speed, ncol = 3, scales = "fixed") + 
  ylab ("H1 (Nm/kg)") +
  xlab ("Age") +
  labs (color = "Age(years)") +
  theme_half_open()


f

```

```{r}

df.plot <- bind_cols(nd, p) %>%
  filter (cycle > 50) %>%
  mutate (age = factor (age))%>%
  mutate (speed = factor (speed)) %>%
  group_by(age, speed) %>%
  mutate (h3 = max (Mean)) %>%
  ungroup () %>%
  filter (Mean == h3)


f <- ggplot(data = df.plot) +
  geom_point (aes (x = age, y = Mean, color = age), size = 2) + 
  geom_errorbar(aes(x = age, ymin = `2.5%`, ymax = `97.5%`, color = age), size = 1) + 
  scale_color_manual(values = cbp2) +
  facet_wrap(~speed, ncol = 3, scales = "fixed") + 
  ylab ("H3 (Nm/kg)") +
  xlab ("Age") +
  labs (color = "Age(years)") +
  theme_half_open()


f

```