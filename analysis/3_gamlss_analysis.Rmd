---
title: "3_gamlss_analysis"
output: html_notebook
editor_options: 
  chunk_output_type: console
---
  
# Import library
  
```{r}

rm (list = ls())

# Helper
library (tidyverse)

# Import
library (rio)

# Exploration 
library (DataExplorer)
library (janitor)
library (arsenal)
library (ggforce)
library (moments)

# modelling
library (gamlss)
library (gamlss.add)
library (bamlss)
library (bigsplines)

# parallel
library(doParallel)
library(foreach)
library (furrr)

# Plotting
library (distreg.vis)
library (plotly)



```

# Import data

```{r}

output_dir <- "../output"
file_name <- "df_clean.RDS"

df <- readRDS (file.path(output_dir, file_name))


```

# Subset data

```{r}

df_ankle <- df  %>%
  filter (joint == "ankle") 

df_knee <- df %>%
  filter (joint  == "knee")

df_hip <- df  %>%
  filter (joint  == "hip")

df_ankle[c("study","subj","sex")] <- lapply(df_ankle[c("study","subj","sex")], factor)
df_knee[c("study","subj","sex")] <- lapply(df_knee[c("study","subj","sex")], factor)
df_hip[c("study","subj","sex")] <- lapply(df_hip[c("study","subj","sex")], factor)

```


# GAMLSS modelling

## ankle

### Sample the data

```{r}

age_cut <- seq (5, 95, 10)
age_labels <- paste0 (paste (age_cut, "-", age_cut[-1])[-length (age_cut)], " (yo)")

speed_cut <- seq (0.5, 2.0, 0.5)
speed_labels <- paste (speed_cut, "-", speed_cut[-1])[-length (speed_cut)]

cycle_cut <- seq (0, 106, 5)
cycle_labels <- seq (1, 105, 5)

df_ankle_downsamp <- df_ankle %>%
  filter (cycle %in% seq (1, 101, 3))

add_cat <-  df_ankle_downsamp %>%
  mutate (age_cat  = cut (age, age_cut, labels = age_labels),
          speed_cat  = cut (speed, speed_cut, labels = speed_labels)) %>%
  group_by(age_cat, speed_cat) 

min_sample <- add_cat %>%
  tally () %>%
  pull (n) %>%
  min()

df_ankle_sub <- add_cat %>%
  sample_n (min_sample)


```


### find optimal distribution

```{r}

m0 <- fitDist(val, data = df_ankle_sub, type = "realline")
m0$fits


saveRDS(m0, file.path(output_dir, "ankle_gamlss_m0.RDS"))
```

### explore models

```{r}

# tensor
m1 <- gamlss(val ~  ga (~ te(cycle, age, speed)),
             sigma.fo = ~ ga (~ te(cycle, age, speed)),
             family = SHASH,
             data = df_ankle_sub,
             c.crit = 0.1,
             trace = FALSE)

saveRDS(m1, file.path(output_dir, "ankle_gamlss_m1.RDS"))

m2 <- gamlss(val ~ ga (~ te(cycle, age, speed)),
             family = SEP2,
             data = df_ankle_sub,
             c.crit = 0.1,
             trace = FALSE)

saveRDS(m2, file.path(output_dir, "ankle_gamlss_m2.RDS"))

m3 <- gamlss(val ~ ga (~ te(cycle, age, speed)),
             sigma.fo = ~ ga (~ te(cycle, age, speed)),
             nu.fo = ~  ga (~ te(cycle, age, speed)) ,
             #tau.fo = ~ ga (~ te(cycle, age, speed)) ,
             family = SEP2,
             data = df_ankle_sub,
             c.crit = 0.1,
             trace = FALSE)

saveRDS(m3, file.path(output_dir, "ankle_gamlss_m3.RDS"))

m4 <- gamlss(val ~ pb (cycle) + pb (age) + pb(speed) + 
               pvc (cycle, by = age) + pvc(cycle, by = speed) + pvc(speed, by = age),
             family = SHASH,
             data = df_ankle_sub,
             c.crit = 0.1,
             trace = FALSE)

saveRDS(m4, file.path(output_dir, "ankle_gamlss_m4.RDS"))

m5 <- gamlss(val ~ pb (cycle) + pb (age) + pb(speed) + 
               pvc (cycle, by = age) + pvc(cycle, by = speed) + pvc(speed, by = age),
             sigma.fo = ~ pb (cycle) + pb (age) + pb(speed) + 
               pvc (cycle, by = age) + pvc(cycle, by = speed) + pvc(speed, by = age),
             family = SHASH,
             data = df_ankle_sub,
             c.crit = 0.1,
             trace = FALSE)

saveRDS(m5, file.path(output_dir, "ankle_gamlss_m5.RDS"))

m6 <- gamlss(val ~ sex + pb (cycle) + pb (age) + pb(speed) + 
               pvc (cycle, by = age) + pvc(cycle, by = speed) + pvc(speed, by = age),
             sigma.fo = ~ pb (cycle) + pb (age) + pb(speed) + 
               pvc (cycle, by = age) + pvc(cycle, by = speed) + pvc(speed, by = age),
             family = SHASH,
             data = df_ankle_sub,
             c.crit = 0.001,
             trace = FALSE)

saveRDS(m6, file.path(output_dir, "ankle_gamlss_m6.RDS"))

m7 <- gamlss(val ~ sex + pb (cycle) + pb (age) + pb(speed) + 
               pvc (cycle, by = age) + pvc(cycle, by = speed) + pvc(speed, by = age),
             sigma.fo = ~ pb (cycle) + pb (age) + pb(speed) + 
               pvc (cycle, by = age) + pvc(cycle, by = speed) + pvc(speed, by = age),
             family = SHASH,
             data = df_ankle_downsamp,
             c.crit = 0.001,
             trace = FALSE)

saveRDS(m7, file.path(output_dir, "ankle_gamlss_m7.RDS"))


```

### try smoothing splines

```{r}

num_prm <- 0.01
ord_prm <- 1

m <- bigssa (val ~ sex+ cycle*speed*age,
             type=list(sex = "nom", cycle = "per", age = "cub", speed ="cub"),
             rparm=list(cycle = num_prm, speed = num_prm, age = num_prm, sex = ord_prm),
             nknots=100,
             data = df_ankle_downsamp,
             skip.iter=T)

s <- summary (m, fitresid = TRUE)

plot (s$fitted.values, s$residuals)

# plot results --------------------------


plot_res <- function (model, cycle, age, speed) {
  
  newdata <- expand.grid(cycle = cycle,
                       age = age,
                       speed = speed)
  
  yhat = predict(model,
               newdata = newdata,
               se.fit=TRUE,
               include= c("age", "cycle", "speed"),
               includeint=T)
  
  yhat_df <- bind_rows(yhat) %>%
    bind_cols(newdata) %>%
    mutate (lwr = fit - 2*se.fit,
            upr = fit + 2*se.fit)
  
  zlist <- list (yhat = yhat_df ,
                 z = matrix (yhat_df[, "fit"] %>% pull(), nrow = length (cycle), ncol = length (age)),
                 z_lwr = matrix (yhat_df[, "lwr"] %>% pull(), nrow = length (cycle), ncol = length (age)),
                 z_upr = matrix (yhat_df[, "upr"] %>% pull(), nrow = length (cycle), ncol = length (age))
                 )
  
  return (zlist)
  
}

cycle <- 1:101
age <- 5:85
slow <- 0.7
mod <- 1.2
fast <- 1.8

surface_slow <- plot_res(model = m, cycle = cycle, age = age, speed = slow)
surface_mod <- plot_res(model = m, cycle = cycle, age = age, speed = mod)
surface_fast <- plot_res(model = m, cycle = cycle, age = age, speed = fast)

f_slow <- plot_ly(showscale = FALSE, scene='scene1') %>%
  add_surface(z = ~ surface_slow$z) %>%
  add_surface(z = ~ surface_slow$z_lwr, opacity = 0.5) %>%
  add_surface(z = ~ surface_slow$z_upr, opacity = 0.5) 

f_mod<- plot_ly(showscale = FALSE, scene='scene2') %>%
  add_surface(z = ~ surface_mod$z) %>%
  add_surface(z = ~ surface_mod$z_lwr, opacity = 0.5) %>%
  add_surface(z = ~ surface_mod$z_upr, opacity = 0.5)


f_fast <- plot_ly(showscale = FALSE, scene = "scene3") %>%
  add_surface(z = ~ surface_fast$z) %>%
  add_surface(z = ~ surface_fast$z_lwr, opacity = 0.5) %>%
  add_surface(z = ~ surface_fast$z_upr, opacity = 0.5) 

f <- subplot(f_slow, f_mod, f_fast, shareX = TRUE, shareY = TRUE) %>%
  layout (title = "ankle power over age",
          scene1 = list(
      xaxis = list(title = "Age (yo)", range = c(85,5)),
      yaxis = list(title = "Cycle (1 - 100%"),
      zaxis = list(title = "Power (W/kg)")))
      
```


## knee

### Sample the data

```{r}

df_knee_downsamp <- df_knee %>%
  filter (cycle %in% seq (1, 101, 3))

add_cat <-  df_knee_downsamp %>%
  mutate (age_cat  = cut (age, age_cut, labels = age_labels),
          speed_cat  = cut (speed, speed_cut, labels = speed_labels)) %>%
  group_by(age_cat, speed_cat) 

min_sample <- add_cat %>%
  tally () %>%
  pull (n) %>%
  min()

df_knee_sub <- add_cat %>%
  sample_n (min_sample)


```


### find optimal distribution

```{r}

m0 <- fitDist(val, data = df_knee_sub, type = "realline")
m0$fits


saveRDS(m0, file.path(output_dir, "knee_gamlss_m0.RDS"))
```

### explore models

```{r}


m1 <- gamlss(val ~  ga (~ te(cycle, age, speed)),
             sigma.fo = ~ ga (~ te(cycle, age, speed)),
             family = SEP1,
             data = df_knee_sub,
             c.crit = 0.1,
             trace = FALSE)

saveRDS(m1, file.path(output_dir, "knee_gamlss_m1.RDS"))


m2 <- gamlss(val ~ pb (cycle) + pb (age) + pb(speed) + 
               pvc (cycle, by = age) + pvc(cycle, by = speed) + pvc(speed, by = age),
             family = SEP1,
             data = df_knee_sub,
             c.crit = 0.1,
             trace = FALSE)

saveRDS(m2, file.path(output_dir, "knee_gamlss_m2.RDS"))


m3 <- gamlss(val ~ sex + pb (cycle) + pb (age) + pb(speed) + 
               pvc (cycle, by = age) + pvc(cycle, by = speed) + pvc(speed, by = age),
             family = SEP1,
             data = df_knee_downsamp,
             c.crit = 0.001,
             trace = FALSE)

saveRDS(m3, file.path(output_dir, "knee_gamlss_m3.RDS"))


```

## hip

### Sample the data

```{r}

df_hip_downsamp <- df_hip %>%
  filter (cycle %in% seq (1, 101, 3))

add_cat <-  df_hip_downsamp %>%
  mutate (age_cat  = cut (age, age_cut, labels = age_labels),
          speed_cat  = cut (speed, speed_cut, labels = speed_labels)) %>%
  group_by(age_cat, speed_cat) 

min_sample <- add_cat %>%
  tally () %>%
  pull (n) %>%
  min()

df_hip_sub <- add_cat %>%
  sample_n (min_sample)


```


### find optimal distribution

```{r}

m0 <- fitDist(val, data = df_hip_sub, type = "realline")
m0$fits


saveRDS(m0, file.path(output_dir, "hip_gamlss_m0.RDS"))
```

### explore models

```{r}


m1 <- gamlss(val ~  ga (~ te(cycle, age, speed)),
             sigma.fo = ~ ga (~ te(cycle, age, speed)),
             family = SHASH,
             data = df_hip_sub,
             c.crit = 0.1,
             trace = FALSE)

saveRDS(m1, file.path(output_dir, "hip_gamlss_m1.RDS"))


m2 <- gamlss(val ~ pb (cycle) + pb (age) + pb(speed) + 
               pvc (cycle, by = age) + pvc(cycle, by = speed) + pvc(speed, by = age),
             family = SEP1,
             data = df_hip_sub,
             c.crit = 0.1,
             trace = FALSE)

saveRDS(m2, file.path(output_dir, "hip_gamlss_m2.RDS"))

m3 <- gamlss(val ~ pb (cycle) + pb (age) + pb(speed) + 
               pvc (cycle, by = age) + pvc(cycle, by = speed) + pvc(speed, by = age),
             sigma.fo = ~ pb (cycle) + pb (age) + pb(speed) + 
               pvc (cycle, by = age) + pvc(cycle, by = speed) + pvc(speed, by = age),
             family = SEP1,
             data = df_hip_sub,
             c.crit = 0.1,
             trace = FALSE)

saveRDS(m3, file.path(output_dir, "hip_gamlss_m3.RDS"))

m4 <- gamlss(val ~  ga (~ te(cycle, age, speed)),
             sigma.fo = ~ ga (~ te(cycle, age, speed)),
             family = SHASH,
             data = df_hip_downsamp,
             c.crit = 0.001,
             trace = FALSE)
saveRDS(m4, file.path(output_dir, "hip_gamlss_m4.RDS"))


```

### GAMLSS with time interaction, REs and data-driven distribution choice

```{r}
form_right = paste(c("~ ba (~ te(cycle, age, speed)",
                   "s(subj, by = study, bs = 're')",
                   "s(study, bs = 're')",
                   "sex + s(wt) + s(ht))"),
                   collapse = " + ")
form_right2 = "~ te(cycle, age, speed) + sex + s(wt) + s(ht)"

m1 <- gamlss(as.formula(paste0("val ", form_right)),
             sigma.fo = as.formula(form_right2),
             family = NO(),
             data = df_ankle,
             trace = FALSE)

m1_rec <- chooseDist(object = m1, type = "realline")
saveRDS(m1, file.path(output_dir, "ankle_gamlss_m1_NO.RDS"))
saveRDS(m1_rec, file.path(output_dir, "ankle_gamlss_m1_rec.RDS"))


m2 <- gamlss(as.formula(paste0("val ", form_right)),
             sigma.fo = as.formula(form_right2),
             family = NO(),
             data = df_knee,
             trace = FALSE)

m2_rec <- chooseDist(object = m2, type = "realline")
saveRDS(m2, file.path(output_dir, "knee_gamlss_m2_NO.RDS"))
saveRDS(m2_rec, file.path(output_dir, "knee_gamlss_m2_rec.RDS"))



m3 <- gamlss(as.formula(paste0("val ", form_right)),
             sigma.fo = as.formula(form_right2),
             family = NO(),
             data = df_hip,
             trace = FALSE)

m3_rec <- chooseDist(object = m3, type = "realline")
saveRDS(m3, file.path(output_dir, "hip_gamlss_m3_NO.RDS"))
saveRDS(m3_rec, file.path(output_dir, "hip_gamlss_m3_rec.RDS"))
```

### GAMLSS with mgcv

```{r}
m1 <- gam(list(
  val  ~ 
    te(cycle, speed) + 
    te(cycle, age) + 
    te(age, speed) + 
    s(subj, by = study, bs = "re") + 
    s(study, bs = "re") + 
    sex + 
    s(wt) + s(ht),
  ~s(cycle)),
  family = gaulss(),
  data = df_ankle)
  
```

