---
title: "3_gamlss_analysis"
output: html_notebook
editor_options: 
  chunk_output_type: console
---
  
# Import library
  
```{r}

rm (list = ls())

# Helper
library (tidyverse)

# Import
library (rio)

# Exploration 
library (DataExplorer)
library (janitor)
library (arsenal)
library (ggforce)

# modelling
library (gamlss)
library (gamlss.add)

# parallel
library(doParallel)
library(foreach)
library (furrr)

```

# Import data

```{r}

output_dir <- "output"
file_name <- "df_clean.RDS"

df <- readRDS (file.path(output_dir, file_name))


```

# Subset data

```{r}

df_ankle <- df  %>%
  filter (joint == "ankle") 

df_knee <- df %>%
  filter (joint  == "knee")

df_hip <- df  %>%
  filter (joint  == "hip")

```

# Explore

## Power against cycle

```{r}


fig_name <- "explore_power_cycle.tiff"


tiff (width = 10, height = 8, units = "in", res = 200, file = file.path(output_dir,  fig_name))

df %>%
  ggplot () +
  geom_point (aes (x = cycle, y = val)) +
  facet_wrap( ~ joint)

dev.off()

```

## Power against age

```{r}

fig_name <- "explore_power_age.tiff"


tiff (width = 10, height = 8, units = "in", res = 200, file = file.path(output_dir,  fig_name))

df %>%
  ggplot () +
  geom_point (aes (x = age, y = val)) +
  facet_wrap( ~ joint)

dev.off()

```

## Power against age

```{r}

fig_name <- "explore_power_speed.tiff"


tiff (width = 10, height = 8, units = "in", res = 200, file = file.path(output_dir,  fig_name))

df %>%
  ggplot () +
  geom_point (aes (x = speed, y = val)) +
  facet_wrap( ~ joint)

dev.off()

```

## Histogram of power

```{r}

fig_name <- "explore_power_hist.tiff"


tiff (width = 10, height = 8, units = "in", res = 200, file = file.path(output_dir,  fig_name))

df %>%
  ggplot () +
  geom_histogram (aes (val), bins = 200) +
  facet_wrap( ~ joint)

dev.off()

```

## Boxplot power against sex

```{r}

fig_name <- "explore_power_sex.tiff"


tiff (width = 10, height = 8, units = "in", res = 200, file = file.path(output_dir,  fig_name))

df %>%
  ggplot () +
  geom_boxplot(aes (x = sex, y = val)) +
  facet_wrap( ~ joint)

dev.off()


```

# GAMLSS modelling

## ankle

```{r}
set.seed(123)
n_subj <- unique (df_ankle$subj)

rand_subj <- sample(n_subj, 200)

df_ankle <- df_ankle %>%
  filter (cycle %in% seq(1, 101, 3),
          subj %in% rand_subj) %>%
  as.data.frame()

# Smoother for mu
m0 <- gamlss(val ~ sex + ga (~ te(cycle, age, speed)) + re (random = ~ 1|study),
             sigma.fo = ~ sex + ga (~ te(cycle, age, speed)) + re (random = ~ 1|study),
             data = df_ankle,
             c.crit = 0.1,
             trace = FALSE)

m0 <- gamlss(val ~ age + speed + sex + ga (~ s(age) + s(cycle) + te (cycle, age)),
             sigma.fo = ~ age + speed + sex + ga (~ s(age) + s(cycle) + te (cycle, age)),
             nu.fo = ~ age + speed + sex + ga (~ s(age) + s(cycle) + te (cycle, age)),
             tau.fo = ~ age + speed + sex + ga (~ s(age) + s(cycle) + te (cycle, age)),
             data = df_walk_apwr_ave,
             family = TF,
             trace = FALSE)


```


