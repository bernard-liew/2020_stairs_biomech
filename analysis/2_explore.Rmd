---
title: "2_explore"
output: html_notebook
editor_options: 
  chunk_output_type: console
---
 
# Import library

```{r}

# Helper
library (tidyverse)

# Import
library (rio)

# Exploration 
library (DataExplorer)
library (janitor)
library (arsenal)
library (ggforce)
library (gganimate)

# functional plots and outliers
library (rainbow)
library (mrfDepth)

# parallel
library(doParallel)
library(foreach)
library (furrr)

# custom 

source ("code/helper_fun.R")

```

# Import raw data from all datasets

```{r}

output_dir <- "output"

list_of_files <- list.files(output_dir, pattern = ".RDS")
incl_studies <- c("fukuchi|taylor|horst|lencioni|schreiber")

list_of_files <- list_of_files[grepl (incl_studies, list_of_files)]

df.list <- list()

for (n in seq_along(list_of_files)) {
  
  
  df.list[[n]] <- readRDS (file.path(output_dir, list_of_files[n]))
  
}

names (df.list) <- str_remove (list_of_files, ".RDS")


```

# Clean data

## lencioni data

```{r}

temp <- df.list$df_lencioni 

temp$study <- "lencioni"

```


## Individual plot
 
```{r}

by_group <- temp %>%
  pivot_wider(names_from = cycle, values_from = val) %>%
  group_by(joint)

by_key <- by_group %>%
  group_keys() 

df_plot <- by_group %>%
  group_split() %>%
  map (.%>% dplyr::select (-(subj:study)) %>% as.matrix)

names(df_plot) <- by_key$joint
  
data_name <- "lencioni" 

fig_name <- "individual_plot.pdf"


pdf (width = 10, height = 8, file = file.path(output_dir, paste0 (data_name, "_", fig_name)))

par(mfrow=c(2,2))

for(i in which(sapply(df_plot, is.matrix))){
  samp_dat <- df_plot[[i]] %>% t()
  samp_fds <- fds (x = c(1:101), 
                   y = samp_dat, 
                   xname = "cycle", 
                   yname = names (df_plot)[i])
  plot.fds(samp_fds)
  
}
dev.off()

```

## Save back to df.list

```{r}
df.list$df_lencioni <- temp
```


## taylor data

```{r}

temp <- df.list$df_taylor %>%
  mutate (study = "taylor") 


```


## Individual plot
 
```{r}
data_name <- "taylor" 

fig_name <- "individual_plot.pdf"

by_group <- temp %>%
  pivot_wider(names_from = cycle, values_from = val) %>%
  group_by(joint)

by_key <- by_group  %>%
  group_keys() 

df_plot <- by_group %>%
  group_split() %>%
  map (.%>% dplyr::select (-(subj:study)) %>% as.matrix)

names(df_plot) <- by_key$joint
  




pdf (width = 10, height = 8, file = file.path(output_dir, paste0 (data_name, "_", fig_name)))

par(mfrow=c(2,2))

for(i in which(sapply(df_plot, is.matrix))){
  samp_dat <- df_plot[[i]] %>% t()
  samp_fds <- fds (x = c(1:101), 
                   y = samp_dat, 
                   xname = "cycle", 
                   yname = names (df_plot)[i])
  plot.fds(samp_fds)
  
}
dev.off()


```

## Remove outlier

```{r}
temp2 <- temp %>%
  pivot_wider(names_from = "cycle",
              values_from = "val")



for (n in seq_along(unique (temp2$joint))) {
  
  var <- unique (temp2$joint)[n]
  
  temp2 [temp2$joint == var, names (temp2) %in% c(1:101)] <- 
    my_outlier(temp2 [temp2$joint == var, names (temp2) %in% c(1:101)])
  
  
  
}

temp3 <- temp2 %>%
  na.omit() %>%
  pivot_longer(cols = c(`1`:`101`),
               names_to = "cycle",
               # names_ptypes = list (cycle = numeric()),
               values_to = "val")

temp3$cycle <- parse_number(temp3$cycle)
```


## recheck individual plot
 
```{r}

fig_name <- "individual_clean_plot.pdf"

by_group <- temp3 %>%
  pivot_wider(names_from = cycle, values_from = val) %>%
  group_by(joint)

by_key <- by_group %>%
  group_keys() 

df_plot <- by_group %>%
  group_split() %>%
  map (.%>% dplyr::select (-(subj:study)) %>% as.matrix)

names(df_plot) <- by_key$joint
  

pdf (width = 10, height = 8, file = file.path(output_dir, paste0 (data_name, "_", fig_name)))

par(mfrow=c(2,2))

for(i in which(sapply(df_plot, is.matrix))){
  samp_dat <- df_plot[[i]] %>% t()
  samp_fds <- fds (x = c(1:101), 
                   y = samp_dat, 
                   xname = "cycle", 
                   yname = names (df_plot)[i])
  plot.fds(samp_fds)
  
}
dev.off()


```

## Save back to df.list

```{r}
df.list$df_taylor <- temp3
```


## horst data

```{r}

temp <- df.list$df_horst %>%
  mutate (study = "horst") %>%
  mutate (val = val/wt) 

```


## Individual plot
 
```{r}

data_name <- "horst" 
fig_name <- "individual_plot.pdf"

by_group <- temp %>%
  pivot_wider(names_from = cycle, values_from = val) %>%
  group_by(joint)

by_key <- by_group %>%
  group_keys() 

df_plot <- by_group %>%
  group_split() %>%
  map (.%>% dplyr::select (-(subj:study)) %>% as.matrix)

names(df_plot) <- by_key$joint
  




pdf (width = 10, height = 8, file = file.path(output_dir, paste0 (data_name, "_", fig_name)))

par(mfrow=c(2,2))

for(i in which(sapply(df_plot, is.matrix))){
  samp_dat <- df_plot[[i]] %>% t()
  samp_fds <- fds (x = c(1:101), 
                   y = samp_dat, 
                   xname = "cycle", 
                   yname = names (df_plot)[i])
  plot.fds(samp_fds)
  
}
dev.off()



```

## Remove outlier

```{r}
temp2 <- temp %>%
  pivot_wider(names_from = "cycle",
              values_from = "val")



for (n in seq_along(unique (temp2$joint))) {
  
  var <- unique (temp2$joint)[n]
  
  temp2 [temp2$joint == var, names (temp2) %in% c(1:101)] <- 
    my_outlier(temp2 [temp2$joint == var, names (temp2) %in% c(1:101)])
  
  
  
}

temp3 <- temp2 %>%
  na.omit() %>%
  pivot_longer(cols = c("1":"101"),
               names_to = "cycle",
               # names_ptypes = list (cycle = numeric()),
               values_to = "val")
temp3$cycle <- parse_number(temp3$cycle)
```


## recheck individual plot
 
```{r}
fig_name <- "individual_clean_plot.pdf"

by_group <- temp3 %>%
  pivot_wider(names_from = cycle, values_from = val) %>%
  group_by(joint)

by_key <- by_group %>%
  group_keys() 

df_plot <- by_group %>%
  group_split() %>%
  map (.%>% dplyr::select (-(subj:study)) %>% as.matrix)

names(df_plot) <- by_key$joint
  




pdf (width = 10, height = 8, file = file.path(output_dir, paste0 (data_name, "_", fig_name)))

par(mfrow=c(2,2))

for(i in which(sapply(df_plot, is.matrix))){
  samp_dat <- df_plot[[i]] %>% t()
  samp_fds <- fds (x = c(1:101), 
                   y = samp_dat, 
                   xname = "cycle", 
                   yname = names (df_plot)[i])
  plot.fds(samp_fds)
  
}
dev.off()




```

## Save back to df.list

```{r}
df.list$df_horst <- temp3
```

## schreiber data

```{r}

temp <- df.list$df_schreiber %>%
  mutate (study = "schreiber") %>%
  mutate (val = val/wt) %>%
  mutate (sex = ifelse (sex == 0, "f", "m")) %>%
  na.omit() 

```


## Individual plot
 
```{r}

data_name <- "schreiber" 

fig_name <- "individual_plot.pdf"


by_group <- temp %>%
  pivot_wider(names_from = cycle, values_from = val) %>%
  group_by(joint)

by_key <- by_group %>%
  group_keys() 

df_plot <- by_group %>%
  group_split() %>%
  map (.%>% dplyr::select (-(subj:study)) %>% as.matrix)

names(df_plot) <- by_key$joint
  

pdf (width = 10, height = 8, file = file.path(output_dir, paste0 (data_name, "_", fig_name)))

par(mfrow=c(2,2))

for(i in which(sapply(df_plot, is.matrix))){
  samp_dat <- df_plot[[i]] %>% t()
  samp_fds <- fds (x = c(1:101), 
                   y = samp_dat, 
                   xname = "cycle", 
                   yname = names (df_plot)[i])
  plot.fds(samp_fds)
  
}
dev.off()



```

## Remove outlier

```{r}
temp2 <- temp %>%
  pivot_wider(names_from = "cycle",
              values_from = "val") %>%
  na.omit()



for (n in seq_along(unique (temp2$joint))) {
  
  var <- unique (temp2$joint)[n]
  
  temp2 [temp2$joint == var, names (temp2) %in% c(1:101)] <- 
    my_outlier(temp2 [temp2$joint == var, names (temp2) %in% c(1:101)])
  
  
  
}

temp3 <- temp2 %>%
  na.omit() %>%
  pivot_longer(cols = c("1":"101"),
               names_to = "cycle",
               # names_ptypes = list (cycle = numeric()),
               values_to = "val")
temp3$cycle <- parse_number(temp3$cycle)

```


## recheck individual plot
 
```{r}

by_group <- temp3 %>%
  pivot_wider(names_from = cycle, values_from = val) %>%
  group_by(joint)

by_key <- by_group %>%
  group_keys() 

df_plot <- by_group %>%
  group_split() %>%
  map (.%>% dplyr::select (-(subj:study)) %>% as.matrix)

names(df_plot) <- by_key$joint
  

fig_name <- "individual_clean_plot.pdf"


pdf (width = 10, height = 8, file = file.path(output_dir, paste0 (data_name, "_", fig_name)))

par(mfrow=c(2,2))

for(i in which(sapply(df_plot, is.matrix))){
  samp_dat <- df_plot[[i]] %>% t()
  samp_fds <- fds (x = c(1:101), 
                   y = samp_dat, 
                   xname = "cycle", 
                   yname = names (df_plot)[i])
  plot.fds(samp_fds)
  
}
dev.off()



```

## Save back to df.list

```{r}
df.list$df_schreiber <- temp3
```

## fukuchi data

```{r}

temp <- df.list$df_fukuchi %>%
  mutate (study = "fukuchi")%>%
  mutate (val = val/wt)


```


## Individual plot
 
```{r}

data_name <- "fukuchi" 

fig_name <- "individual_plot.pdf"


by_group <- temp %>%
  pivot_wider(names_from = cycle, values_from = val) %>%
  group_by(joint)

by_key <- by_group %>%
  group_keys() 

df_plot <- by_group %>%
  group_split() %>%
  map (.%>% dplyr::select (-(subj:study)) %>% as.matrix)

names(df_plot) <- by_key$joint
  

pdf (width = 10, height = 8, file = file.path(output_dir, paste0 (data_name, "_", fig_name)))

par(mfrow=c(2,2))

for(i in which(sapply(df_plot, is.matrix))){
  samp_dat <- df_plot[[i]] %>% t()
  samp_fds <- fds (x = c(1:101), 
                   y = samp_dat, 
                   xname = "cycle", 
                   yname = names (df_plot)[i])
  plot.fds(samp_fds)
  
}
dev.off()




```


## Remove outlier

```{r}
temp2 <- temp %>%
  pivot_wider(names_from = "cycle",
              values_from = "val") %>%
  na.omit ()

for (n in seq_along(unique (temp2$joint))) {
  
  var <- unique (temp2$joint)[n]
  
  temp2 [temp2$joint == var, names (temp2) %in% c(1:101)] <- 
    my_outlier(temp2 [temp2$joint == var, names (temp2) %in% c(1:101)])
  
  
  
}

temp3 <- temp2 %>%
  na.omit() %>%
  pivot_longer(cols = c("1":"101"),
               names_to = "cycle",
               # names_ptypes = list (cycle = numeric()),
               values_to = "val")
temp3$cycle <- parse_number(temp3$cycle)
```


## recheck individual plot
 
```{r}

fig_name <- "individual_clean_plot.pdf"


by_group <- temp3 %>%
  pivot_wider(names_from = cycle, values_from = val) %>%
  group_by(joint)

by_key <- by_group %>%
  group_keys() 

df_plot <- by_group %>%
  group_split() %>%
  map (.%>% dplyr::select (-(subj:study)) %>% as.matrix)

names(df_plot) <- by_key$joint
  

pdf (width = 10, height = 8, file = file.path(output_dir, paste0 (data_name, "_", fig_name)))

par(mfrow=c(2,2))

for(i in which(sapply(df_plot, is.matrix))){
  samp_dat <- df_plot[[i]] %>% t()
  samp_fds <- fds (x = c(1:101), 
                   y = samp_dat, 
                   xname = "cycle", 
                   yname = names (df_plot)[i])
  plot.fds(samp_fds)
  
}
dev.off()




```

## Save back to df.list

```{r}
df.list$df_fukuchi<- temp3
```


# Combine five data into one

## Change subj names

```{r}

for (n in seq_along(df.list)) {
  
  df.list[[n]] <- df.list [[n]] %>%
    mutate (subj = paste0(study, "_", subj))
  
}

```

## Bind df.list

```{r}
df <- df.list %>%
  bind_rows() %>%
  mutate (sex = str_trim(sex)) %>%
  mutate (ht = ifelse (ht > 3, ht / 100, ht)) 
```

# Explore distributions

## Power against cycle

```{r}


fig_name <- "explore_power_cycle.tiff"


tiff (width = 10, height = 8, units = "in", res = 200, file = file.path(output_dir,  fig_name))

df %>%
  ggplot () +
  geom_point (aes (x = cycle, y = val)) +
  facet_wrap( ~ joint)

dev.off()

```

## Power against age

```{r}

fig_name <- "explore_power_age.tiff"


tiff (width = 10, height = 8, units = "in", res = 200, file = file.path(output_dir,  fig_name))

df %>%
  ggplot () +
  geom_point (aes (x = age, y = val)) +
  facet_wrap( ~ joint)

dev.off()

```

## Power against Speed

```{r}

fig_name <- "explore_power_speed.tiff"


tiff (width = 10, height = 8, units = "in", res = 200, file = file.path(output_dir,  fig_name))

df %>%
  ggplot () +
  geom_point (aes (x = speed, y = val)) +
  facet_wrap( ~ joint)

dev.off()

```

## Histogram of power

```{r}

fig_name <- "explore_power_hist.tiff"


tiff (width = 10, height = 8, units = "in", res = 200, file = file.path(output_dir,  fig_name))

df %>%
  ggplot () +
  geom_density (aes (val), adjust = 10) +
  facet_wrap( ~ joint)

dev.off()

```

## Boxplot power against sex

```{r}

fig_name <- "explore_power_sex.tiff"


tiff (width = 10, height = 8, units = "in", res = 200, file = file.path(output_dir,  fig_name))

df %>%
  ggplot () +
  geom_boxplot(aes (x = sex, y = val)) +
  facet_wrap( ~ joint)

dev.off()


```

## Explore SD

### By cycle

```{r}
df %>%
  group_by(subj, joint, cycle) %>%
  summarise(val = sd (val)) %>%
  ggplot () +
  geom_line (aes (x = cycle, y = val)) +
  facet_wrap(~ joint, ncol = 3) +
  geom_hline (yintercept = 0)
```

### By  age

```{r}
df %>%
  group_by(joint, age) %>%
  summarise(val = sd (val)) %>%
  ggplot () +
  geom_line (aes (x = age, y = val )) +
  facet_wrap(~ joint, ncol = 3) +
  geom_hline (yintercept = 0)

```

### By speed

```{r}
df %>%
  group_by(joint, speed) %>%
  summarise(val = sd (val)) %>%
  ggplot () +
  geom_line (aes (x = speed, y = val )) +
  facet_wrap(~ joint, ncol = 3) +
  geom_hline (yintercept = 0)

```

### By height

```{r}
df %>%
  group_by(joint, ht) %>%
  summarise(val = sd (val)) %>%
  ggplot () +
  geom_line (aes (x = ht, y = val )) +
  facet_wrap(~ joint, ncol = 3) +
  geom_hline (yintercept = 0)

```


## Explore Skewness

### By cycle

```{r}
df %>%
  group_by(subj, joint, cycle) %>%
  summarise(val = e1071::skewness (val)) %>%
  ggplot () +
  geom_line (aes (x = cycle, y = val)) +
  facet_wrap(~ joint, ncol = 3) +
  geom_hline (yintercept = 0)
```

### By  age

```{r}
df %>%
  group_by(joint, age) %>%
  summarise(val = e1071::skewness (val)) %>%
  ggplot () +
  geom_line (aes (x = age, y = val )) +
  facet_wrap(~ joint, ncol = 3) +
  geom_hline (yintercept = 0)

```

### By speed

```{r}
df %>%
  group_by(joint, speed) %>%
  summarise(val = e1071::skewness (val)) %>%
  ggplot () +
  geom_line (aes (x = speed, y = val )) +
  facet_wrap(~ joint, ncol = 3) +
  geom_hline (yintercept = 0)

```

### By height

```{r}
df %>%
  group_by(joint, ht) %>%
  summarise(val = e1071::skewness (val)) %>%
  ggplot () +
  geom_line (aes (x = ht, y = val )) +
  facet_wrap(~ joint, ncol = 3) +
  geom_hline (yintercept = 0)

```

## Explore Kurtosis

### By cycle

```{r}
df %>%
  group_by(joint, cycle) %>%
  summarise(val = e1071::kurtosis (val)) %>%
  ggplot () +
  geom_line (aes (x = cycle, y = val )) +
  facet_wrap(~ joint, ncol = 3) +
  geom_hline (yintercept = 3)
```

### By age

```{r}
df %>%
  group_by(joint, age) %>%
  summarise(val = e1071::kurtosis(val)) %>%
  ggplot () +
  geom_line (aes (x = age, y = val )) +
  facet_wrap(~ joint, ncol = 3) +
  geom_hline (yintercept = 3)

```

### By speed

```{r}
df %>%
  group_by(joint, speed) %>%
  summarise(val = e1071::kurtosis(val)) %>%
  ggplot () +
  geom_line (aes (x = speed, y = val )) +
  facet_wrap(~ joint, ncol = 3) +
  geom_hline (yintercept = 3)

```

### By height

```{r}
df %>%
  group_by(joint, ht) %>%
  summarise(val = e1071::kurtosis (val)) %>%
  ggplot () +
  geom_line (aes (x = ht, y = val )) +
  facet_wrap(~ joint, ncol = 3) +
  geom_hline (yintercept = 0)

```

# Export data
 
```{r}

output_dir <- "output"
file_name <- "df_clean_allspeed.RDS"

saveRDS(df, file = file.path(output_dir, file_name))

```


# Further remove outliers

## Keep all speed data

### Import cleaned data

```{r}
rm (list = ls())

frac <- 1

dat <- readRDS("output/df_clean_allspeed.RDS") %>%
  group_by(subj, speed, age, sex, ht, wt, study)%>% 
  sample_frac(frac) %>%
  ungroup () %>%
  mutate(sex = as.factor(sex),
         subj = as.factor(subj),
         study = as.factor(study)) %>%
  as.data.frame() %>%
  arrange (study, subj, joint, cond, speed, cycle)  


```



### Individual plots for all speed

```{r}

dat_wide <- dat %>%
  pivot_wider(names_from = "cycle", values_from = "val")
  
  
by_group <- dat_wide %>%
  group_by(joint)

by_key <- by_group  %>%
  group_keys() 

df_plot <- by_group %>%
  group_split() %>%
  map (.%>% dplyr::select (-(subj:study)) %>% as.matrix)
  
names(df_plot) <- by_key$joint

pdf (width = 10, height = 8, file = file.path("output", "all_data.pdf"))

par(mfrow=c(2,2))

for(i in which(sapply(df_plot, is.matrix))){
  samp_dat <- df_plot[[i]] %>% t()
  samp_fds <- fds (x = c(1:101), 
                   y = samp_dat, 
                   xname = "cycle", 
                   yname = names (df_plot)[i])
  plot.fds(samp_fds)
  
}
dev.off()

  
```

### Remove outliers and replot

```{r}

temp2 <- dat_wide



for (n in seq_along(unique (temp2$joint))) {
  
  var <- unique (temp2$joint)[n]
  
  temp2 [temp2$joint == var, names (temp2) %in% c(1:101)] <- 
    my_outlier(temp2 [temp2$joint == var, names (temp2) %in% c(1:101)])
  
  
  
}

temp3 <- temp2 %>%
  na.omit() %>%
  pivot_longer(cols = c(`1`:`101`),
               names_to = "cycle",
               # names_ptypes = list (cycle = numeric()),
               values_to = "val")

temp3$cycle <- parse_number(temp3$cycle)

temp4 <- temp3 %>%
  pivot_wider(names_from = "cycle", values_from = "val")


by_group <- temp4 %>%
  group_by(joint)

by_key <- by_group  %>%
  group_keys() 

df_plot <- by_group %>%
  group_split() %>%
  map (.%>% dplyr::select (-(subj:study)) %>% as.matrix)

names(df_plot) <- by_key$joint



pdf (width = 10, height = 8, file = file.path("output", "all_data_clean.pdf"))

par(mfrow=c(2,2))

for(i in which(sapply(df_plot, is.matrix))){
  samp_dat <- df_plot[[i]] %>% t()
  samp_fds <- fds (x = c(1:101), 
                   y = samp_dat, 
                   xname = "cycle", 
                   yname = names (df_plot)[i])
  plot.fds(samp_fds)
  
}
dev.off()


```

### Export cleaned datadata
 
```{r}

output_dir <- "output"
file_name <- "df_clean_allspeed_outRm.RDS"

saveRDS(temp3, file = file.path(output_dir, file_name))

```

### Group plot power over cycle, age, speed

```{r}

temp3

age_cut <- seq (10, 90, 10)
age_labels <- paste0 (paste (age_cut, "-", age_cut[-1])[-length (age_cut)], " (yo)")

speed_cut <- seq (0, 2.4, 0.2)
speed_labels <- paste (speed_cut, "-", speed_cut[-1])[-length (speed_cut)]

df_plot <- temp3 %>%
  filter(study != "lencioni") %>% # data reported dissimilar to others
  mutate (age_cat  = cut (age, age_cut, labels = age_labels),
          speed_cat  = cut (speed, speed_cut, labels = speed_labels)) %>%
  group_by(speed_cat, age_cat, joint, cycle) %>%
  summarize (val.mean = mean(val, na.rm = TRUE)) 

f <- ggplot (data = df_plot) +
  geom_line (aes (x = cycle, y = val.mean, colour = age_cat)) +
  guides(colour = guide_legend(title="Age (yrs)")) +
  facet_wrap_paginate(speed_cat~joint, ncol = 3, nrow = 3, scales = "free")

n <- n_pages(f)

fig_name <- "summary_plots.pdf"

pdf (width = 10, height = 8, file = file.path(output_dir, fig_name))

for (i in 1:n) {
  
  print (f + facet_wrap_paginate(speed_cat~joint, ncol = 3, nrow = 3,  page = i, scales = "free"))
  
}

dev.off()

```

## Self speed data only

### Import cleaned data

```{r}
rm (list = ls())

dat <- readRDS("output/df_clean_allspeed.RDS") %>%
  filter (cond %in% c("walkt05", "self", "c4")) %>% 
  group_by(subj, speed, age, sex, ht, wt, study)%>% 
  sample_frac(frac) %>%
  ungroup () %>%
  mutate(sex = as.factor(sex),
         subj = as.factor(subj),
         study = as.factor(study)) %>%
  as.data.frame() %>%
  arrange (study, subj, joint, cond, speed, cycle)  

output_dir <- "output"
file_name <- "df_clean_self.RDS"

saveRDS(dat, file = file.path(output_dir, file_name))


```


### Plot all curves

```{r}
frac <- 1

dat_wide <- dat %>%
  pivot_wider(names_from = "cycle", values_from = "val")

by_group <- dat_wide %>%
  group_by(joint)

by_key <- by_group  %>%
  group_keys() 

df_plot <- by_group %>%
  group_split() %>%
  map (.%>% dplyr::select (-(subj:study)) %>% as.matrix)
  
names(df_plot) <- by_key$joint

pdf (width = 10, height = 8, file = file.path("output", "all_data.pdf"))

par(mfrow=c(2,2))

for(i in which(sapply(df_plot, is.matrix))){
  samp_dat <- df_plot[[i]] %>% t()
  samp_fds <- fds (x = c(1:101), 
                   y = samp_dat, 
                   xname = "cycle", 
                   yname = names (df_plot)[i])
  plot.fds(samp_fds)
  
}
dev.off()

  
```

### Remove outliers and replot

```{r}

dat_wide <- dat %>%
  pivot_wider(names_from = "cycle", values_from = "val")
  

temp2 <- dat_wide



for (n in seq_along(unique (temp2$joint))) {
  
  var <- unique (temp2$joint)[n]
  
  temp2 [temp2$joint == var, names (temp2) %in% c(1:101)] <- 
    my_outlier(temp2 [temp2$joint == var, names (temp2) %in% c(1:101)])
  
  
  
}

temp3 <- temp2 %>%
  na.omit() %>%
  pivot_longer(cols = c(`1`:`101`),
               names_to = "cycle",
               # names_ptypes = list (cycle = numeric()),
               values_to = "val")

temp3$cycle <- parse_number(temp3$cycle)


temp4 <- temp3 %>%
  pivot_wider(names_from = "cycle", values_from = "val")


by_group <- temp4 %>%
  group_by(joint)

by_key <- by_group  %>%
  group_keys() 

df_plot <- by_group %>%
  group_split() %>%
  map (.%>% dplyr::select (-(subj:study)) %>% as.matrix)

names(df_plot) <- by_key$joint





pdf (width = 10, height = 8, file = file.path("output", "all_data_clean.pdf"))

par(mfrow=c(2,2))

for(i in which(sapply(df_plot, is.matrix))){
  samp_dat <- df_plot[[i]] %>% t()
  samp_fds <- fds (x = c(1:101), 
                   y = samp_dat, 
                   xname = "cycle", 
                   yname = names (df_plot)[i])
  plot.fds(samp_fds)
  
}
dev.off()


```


### Export data
 
```{r}

output_dir <- "output"
file_name <- "df_clean_self_outRm.RDS"

saveRDS(temp3, file = file.path(output_dir, file_name))

```

### Plot of power over cycle, age, speed

```{r}

temp3

age_cut <- seq (10, 90, 10)
age_labels <- paste0 (paste (age_cut, "-", age_cut[-1])[-length (age_cut)], " (yo)")

speed_cut <- seq (0.6, 2.4, 0.2)
speed_labels <- paste (speed_cut, "-", speed_cut[-1])[-length (speed_cut)]

df_plot <- temp3 %>%
  filter(study != "lencioni") %>% # data reported dissimilar to others
  mutate (age_cat  = cut (age, age_cut, labels = age_labels),
          speed_cat  = cut (speed, speed_cut, labels = speed_labels)) %>%
  group_by(speed_cat, age_cat, joint, cycle) %>%
  summarize (val.mean = mean(val, na.rm = TRUE)) 

f <- ggplot (data = df_plot) +
  geom_line (aes (x = cycle, y = val.mean, colour = age_cat)) +
  guides(colour = guide_legend(title="Age (yrs)")) +
  facet_wrap_paginate(speed_cat~joint, ncol = 3, nrow = 3, scales = "free")

n <- n_pages(f)

fig_name <- "summary_self_plots.pdf"

pdf (width = 10, height = 8, file = file.path(output_dir, fig_name))

for (i in 1:n) {
  
  print (f + facet_wrap_paginate(speed_cat~joint, ncol = 3, nrow = 3,  page = i, scales = "free"))
  
}

dev.off()

```